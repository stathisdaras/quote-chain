<div class="tool-bar">
  <p-confirmDialog></p-confirmDialog>
  <p-toast></p-toast>

  <div class="upload-section">
    <div class="upload-controls">
      <div class="button-group">
        <p-button 
          label="CSV"
          icon="pi pi-upload"
          (onClick)="onUploadButtonClick()"
          styleClass="p-button-success"
        ></p-button>
        <p-button 
          (onClick)="onNukemClick()"
          styleClass="p-button-danger"
          pTooltip="Delete all highlights permanently"
          tooltipPosition="bottom"
        >
          <ng-template pTemplate="content">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem; vertical-align: middle;">
              <!-- Mushroom cloud - top mushroom shape -->
              <path d="M12 3C8.13 3 5 6.13 5 10c0 1.5.6 2.87 1.58 3.87L6 17h12l-.58-3.13C18.4 12.87 19 11.5 19 10c0-3.87-3.13-7-7-7z" fill="currentColor"/>
              <!-- Mushroom cloud - stem -->
              <rect x="11" y="17" width="2" height="4" fill="currentColor"/>
              <!-- Mushroom cloud - base explosion -->
              <ellipse cx="12" cy="22" rx="7" ry="2" fill="currentColor" opacity="0.7"/>
              <ellipse cx="12" cy="21.5" rx="5" ry="1.5" fill="currentColor" opacity="0.5"/>
            </svg>
            <span>Nuke</span>
          </ng-template>
        </p-button>
      </div>
      <div class="rag-toggle-container">
        <label class="rag-label" 
               pTooltip="RAG (Retrieval-Augmented Generation) mode combines semantic search with AI model responses. When enabled, search results are presented as a chatbot conversation instead of a table, using the top 10 most relevant highlights to generate contextual answers."
               tooltipPosition="bottom">RAG</label>
        <p-inputSwitch 
          [(ngModel)]="ragEnabled"
          (onChange)="onRAGToggled()"
        ></p-inputSwitch>
      </div>
    </div>
  </div>

  <p-dialog 
    header="Upload CSV File" 
    [(visible)]="showUploadDialog"
    [modal]="true"
    [style]="{width: '500px'}"
    [closable]="true"
    (onHide)="closeUploadDialog()"
  >
    <div class="upload-dialog-content">
      <div class="file-selection">
        <input 
          type="file" 
          id="dialogFileInput"
          accept=".csv" 
          (change)="onDialogFileSelected($event)"
          class="file-input"
        />
        <p-button 
          label="Choose File"
          icon="pi pi-file"
          (onClick)="triggerFileInput()"
          styleClass="p-button-secondary"
        ></p-button>
        <span *ngIf="selectedFile" class="selected-file-name">{{ selectedFile.name }}</span>
        <span *ngIf="!selectedFile" class="no-file-selected">No file selected</span>
      </div>

      <div class="overwrite-section">
        <p-checkbox 
          [(ngModel)]="overwriteExisting"
          [binary]="true"
          inputId="overwriteCheckbox"
        ></p-checkbox>
        <label for="overwriteCheckbox" class="checkbox-label">Overwrite existing entries</label>
      </div>

      <div *ngIf="overwriteExisting" class="warning-container">
        <div class="achtung-message">
          <strong>ACHTUNG:</strong> this flag will nuke existing highlights
        </div>
      </div>

      <div *ngIf="uploadError" class="error-message">{{ uploadError }}</div>

      <div class="dialog-actions">
        <p-button 
          label="Upload"
          icon="pi pi-upload"
          [loading]="isUploading"
          (onClick)="uploadFile()"
          [disabled]="!selectedFile || isUploading"
          styleClass="p-button-success"
        ></p-button>
        <p-button 
          label="Cancel"
          icon="pi pi-times"
          (onClick)="closeUploadDialog()"
          [disabled]="isUploading"
          styleClass="p-button-secondary"
        ></p-button>
      </div>
    </div>
  </p-dialog>

  <div class="search-section">
    <div class="search-inputs">
      <input 
        type="text" 
        pInputText
        [(ngModel)]="searchPrompt" 
        [placeholder]="ragEnabled ? 'Ask a question about your highlights...' : 'Search highlights...'"
        class="search-input"
        (keyup.enter)="onSearch()"
      />
      <input 
        type="text" 
        pInputText
        [(ngModel)]="tags" 
        placeholder="Tags (comma-separated)"
        class="tags-input"
        (keyup.enter)="onSearch()"
      />
      <p-button 
        label=""
        icon="pi pi-search"
        [loading]="isSearching || isGeneratingResponse"
        (onClick)="onSearch()"
        [disabled]="(isSearching || isGeneratingResponse) || !searchPrompt.trim()"
        styleClass="p-button-success"
      ></p-button>
      <p-button 
        label=""
        icon="pi pi-times"
        (onClick)="clearSearch()"
        [disabled]="isSearching || isGeneratingResponse"
        styleClass="p-button-secondary"
      ></p-button>
    </div>
    <div *ngIf="searchError" class="error-message">{{ searchError }}</div>
  </div>

  <!-- Chatbot UI when RAG is enabled -->
  <div *ngIf="ragEnabled" class="chat-container">
    <div class="chat-messages">
      <div *ngFor="let message of chatMessages" class="chat-message" [ngClass]="'chat-message-' + message.role">
        <div class="message-content">
          <div class="message-role">{{ message.role === 'user' ? 'You' : 'Assistant' }}</div>
          <div class="message-text">{{ message.content }}</div>
        </div>
      </div>
      <div *ngIf="isGeneratingResponse" class="chat-message chat-message-assistant">
        <div class="message-content">
          <div class="message-role">Assistant</div>
          <div class="message-text">
            <i class="pi pi-spin pi-spinner" style="margin-right: 0.5rem;"></i>
            Generating response...
          </div>
        </div>
      </div>
      <div *ngIf="chatMessages.length === 0 && !isGeneratingResponse" class="chat-empty">
        <p>Start a conversation by asking a question about your highlights.</p>
        <p class="chat-hint">Example: "What did Steve Jobs say about work?"</p>
      </div>
    </div>
  </div>

  <!-- Table UI when RAG is disabled -->
  <div *ngIf="!ragEnabled" class="highlights-container">
    <p-table 
      [value]="highlights" 
      [loading]="isLoadingHighlights || isSearching"
      [paginator]="true"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [lazy]="!isSearchMode"
      (onLazyLoad)="onPageChange($event)"
      [rowsPerPageOptions]="[10, 25, 50]"
      [first]="first"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} highlights"
      styleClass="p-datatable-striped"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 40%">Highlight</th>
          <th style="width: 25%">Book</th>
          <th style="width: 20%">Author</th>
          <th style="width: 10%">Tags</th>
          <th style="width: 5%" *ngIf="isSearchMode">Score</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-highlight>
        <tr>
          <td>
            <div class="highlight-text">"{{ highlight.content }}"</div>
          </td>
          <td>
            <strong>{{ highlight.book_title }}</strong>
          </td>
          <td>{{ highlight.book_author || 'Unknown' }}</td>
          <td>
            <div *ngIf="highlight.tags.length > 0" class="tags">
              <span *ngFor="let tag of highlight.tags" class="tag">{{ tag }}</span>
            </div>
            <span *ngIf="highlight.tags.length === 0" class="no-tags">-</span>
          </td>
          <td *ngIf="isSearchMode">
            <span class="score">{{ (highlight.score * 100).toFixed(1) }}%</span>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="isSearchMode ? 5 : 4" class="empty-message">
            <div *ngIf="!isLoadingHighlights && !isSearching">
              No highlights found.
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

